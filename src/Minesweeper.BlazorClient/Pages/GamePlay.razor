@inject Minesweeper.BlazorClient.Services.IMinesweeperService MinesweeperService
@using Minesweeper.BlazorClient.Components
@using Minesweeper.BlazorClient.Models

<PageTitle>Minesweeper</PageTitle>

<div class="game-container">
    <DifficultySelector Difficulties="Difficulties" SelectedDifficulty="SelectedDifficulty" OnDifficultyChange="OnDifficultyChange" />
    <button @onclick="StartNewGame">New Game</button>
    <MineCounter MineCount="Game?.MineCount ?? 0" />
    <Timer ElapsedSeconds="ElapsedSeconds" />
    @if (Game != null && Game.Cells != null)
    {
        <MinesweeperGrid Rows="Game.Rows" Columns="Game.Columns" Cells="Game.Cells" OnCellReveal="OnCellReveal" OnCellFlag="OnCellFlag" />
    }
    <div class="game-status">Status: @Game?.Status</div>
</div>

@code {
    private List<DifficultyModel> Difficulties = new();
    private string SelectedDifficulty = "Beginner";
    private GameModel? Game;
    private int ElapsedSeconds = 0;
    private System.Timers.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        Difficulties = await MinesweeperService.GetDifficultiesAsync();
        await StartNewGame();
    }

    private async Task StartNewGame()
    {
        Game = await MinesweeperService.StartNewGameAsync(SelectedDifficulty);
        ElapsedSeconds = 0;
        StartTimer();
        StateHasChanged();
    }

    private void StartTimer()
    {
        timer?.Stop();
        timer = new System.Timers.Timer(1000);
        timer.Elapsed += (s, e) => {
            if (Game?.Status == "InProgress")
            {
                ElapsedSeconds++;
                InvokeAsync(StateHasChanged);
            }
            else
            {
                timer?.Stop();
            }
        };
        timer.Start();
    }

    private async Task OnCellReveal((int row, int col) pos)
    {
        if (Game == null) return;
        Game = await MinesweeperService.RevealCellAsync(Game.Id, pos.row, pos.col);
        StateHasChanged();
    }

    private async Task OnCellFlag((int row, int col) pos)
    {
        if (Game == null) return;
        Game = await MinesweeperService.FlagCellAsync(Game.Id, pos.row, pos.col);
        StateHasChanged();
    }

    private async Task OnDifficultyChange(string difficulty)
    {
        SelectedDifficulty = difficulty;
        await StartNewGame();
    }
}
